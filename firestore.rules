rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // SECURITY CRITICAL: These rules protect against balance manipulation attacks
    // ============================================================================
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAuthenticatedUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin(userId) {
      return isAuthenticated() && get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function canReadPublicData() {
      return isAuthenticated();
    }
    
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function isValidAmount(amount) {
      return amount is number && amount > 0 && amount <= 100000;
    }
    
    function isValidPhoneNumber(phone) {
      return phone.matches('^[0-9]{10}$');
    }
    
    function isValidUPI(upi) {
      return upi.matches('^[a-zA-Z0-9._-]+@[a-zA-Z]+$');
    }

    // Users collection
    match /users/{userId} {
      // ✅ Users can read their own data or public profiles
      allow read: if isAuthenticatedUser(userId) || 
                     (isAuthenticated() && resource.data.profilePublic == true);
      
      // ✅ CRITICAL FIX: Backend uses Admin SDK (bypasses rules)
      // Users can ONLY update safe profile fields
      allow update: if isAuthenticatedUser(userId) &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['upiId', 'displayName', 'profilePicture']) &&
                       request.resource.data.upiId.matches('^[a-zA-Z0-9._-]+@[a-zA-Z]+$');
      
      // ✅ Backend creates users via Admin SDK
      allow create: if false; // Only backend can create
      allow delete: if isAdmin(userId);
      
      // Transactions subcollection
      match /transactions/{transactionId} {
        allow read: if isAuthenticatedUser(userId);
        
        // ✅ ONLY BACKEND CAN WRITE TRANSACTIONS (via Admin SDK)
        allow create, update, delete: if false;
      }
      
      // Game results subcollection
      match /gameResults/{gameResultId} {
        allow read: if isAuthenticatedUser(userId);
        
        // ✅ ONLY BACKEND CAN WRITE GAME RESULTS (via Admin SDK)
        allow create, update, delete: if false;
      }
    }
    
    // Public leaderboard collection
    match /leaderboard/{entry} {
      allow read: if isAuthenticated();
      allow write: if false; // Only backend via Admin SDK
    }
    
    // Game questions collection
    match /gameQuestions/{questionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin(request.auth.uid);
    }
    
    // Tasks collection
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin(request.auth.uid);
      
      // User task completions
      match /completions/{completionId} {
        allow read: if isAuthenticatedUser(request.auth.uid);
        // ✅ ONLY BACKEND CAN WRITE COMPLETIONS (via Admin SDK)
        allow create, update, delete: if false;
      }
    }
    
    // Withdrawal requests
    match /withdrawalRequests/{requestId} {
      allow read: if isAuthenticatedUser(resource.data.userId) || isAdmin(request.auth.uid);
      
      // ✅ ONLY BACKEND CAN CREATE WITHDRAWAL REQUESTS (via Admin SDK)
      allow create: if false;
      
      // User can CANCEL pending requests
      allow update: if isAuthenticatedUser(resource.data.userId) &&
                       resource.data.status == 'pending' &&
                       request.resource.data.status == 'cancelled';
      
      allow delete: if false;
    }
    
    // Withdrawals collection (created by backend)
    match /withdrawals/{withdrawalId} {
      allow read: if isAuthenticatedUser(resource.data.userId) || isAdmin(request.auth.uid);
      allow create, update, delete: if false; // Only backend via Admin SDK
    }
    
    // Referral program collection
    match /referrals/{referralId} {
      allow read: if isAuthenticated();
      
      // ✅ ONLY BACKEND CAN CREATE REFERRALS (via Admin SDK)
      allow create, update, delete: if false;
      
      // Referral usages subcollection
      match /usages/{usageId} {
        allow read: if isAuthenticatedUser(resource.data.userId);
        // ✅ ONLY BACKEND CAN WRITE USAGES (via Admin SDK)
        allow create, update, delete: if false;
      }
    }
    
    // Admin logs collection
    match /adminLogs/{logId} {
      allow read, write: if isAdmin(request.auth.uid);
    }
    
    // Request deduplication cache
    match /requestCache/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                       request.resource.data.keys().hasAll(['requestId', 'requestHash', 'timestamp', 'success']) &&
                       request.resource.data.requestId == requestId;
      allow update, delete: if false;
    }
    
    // Audit logs
    match /auditLogs/{logId} {
      allow read: if isAuthenticatedUser(resource.data.userId) || isAdmin(request.auth.uid);
      allow create, update, delete: if false; // Only backend via Admin SDK
    }
    
    // Device fingerprints
    match /deviceFingerprints/{fingerprintId} {
      allow read: if isAuthenticated();
      // ✅ CRITICAL FIX: Only backend can write fingerprints (prevents pollution)
      allow create, update, delete: if false; // Only backend via Admin SDK
    }
    
    // Analytics collection
    match /analytics/{eventId} {
      allow read: if isAdmin(request.auth.uid);
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    // User sessions
    match /userSessions/{sessionId} {
      allow read: if isAuthenticatedUser(resource.data.userId);
      allow create: if isAuthenticatedUser(request.resource.data.userId);
      allow update: if isAuthenticatedUser(resource.data.userId);
      allow delete: if isAuthenticatedUser(resource.data.userId);
    }
    
    // Notifications collection
    match /users/{userId}/notifications/{notificationId} {
      allow read: if isAuthenticatedUser(userId);
      allow create: if false; // Only backend via Admin SDK
      allow update: if isAuthenticatedUser(userId); // Mark as read
      allow delete: if isAuthenticatedUser(userId);
    }
  }
}
